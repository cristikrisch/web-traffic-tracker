(function(){
    // Find this script tag and read API from data-api
    var s = document.currentScript || (function(){var a=document.getElementsByTagName("script");return a[a.length-1];})();
    var API = s && s.getAttribute("data-api");
    if(!API) return; // do nothing if not configured

    var ua = navigator.userAgent || "";
    var isBot =
        /(bot|crawl|spider|scanner|archive|slurp|fetch|monitor)/i.test(ua) ||
        navigator.webdriver === true ||
        (typeof navigator.doNotTrack !== "undefined" && navigator.doNotTrack === "1");
    if (isBot) return;                    // skip known bots
    if (document.visibilityState === "prerender") return; // skip prerendered pages

    // --- Durable visitorKey (localStorage â†’ cookie fallback)
    var KEY_NAME = "yt_vkey";
    function genId(){
        try {
            if (window.crypto && crypto.getRandomValues && window.Uint32Array) {
                var a = new Uint32Array(4);
                crypto.getRandomValues(a);
                var str = "";
                for (var i=0;i<a.length;i++)
                    str += a[i].toString(36);
                return str + Date.now();
            }
        } catch(e){}
        return Math.random().toString(36).slice(2) + Date.now();
    }

    function getCookie(name){
        var m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.*+?^${}()|\[\]\/\\])/g,'\\$1')+'=([^;]*)'));
        return m ? decodeURIComponent(m[1]) : null;
    }
    function setCookie(name,val,maxAge){
        document.cookie = name + "=" + encodeURIComponent(val) + "; Path=/; Max-Age=" + maxAge + "; SameSite=Lax";
    }

    function getVisitorKey(){
        try {
            var k = localStorage.getItem(KEY_NAME);
            if (!k) { k = genId(); localStorage.setItem(KEY_NAME, k); }
            return k;
        } catch(e) {
            var k2 = getCookie(KEY_NAME);
            if (k2) return k2;
            k2 = genId();
            setCookie(KEY_NAME, k2, 60*60*24*365); // 1 year
            return k2;
        }
    }
    var vkey = getVisitorKey();

    // Build payload (now includes visitorKey)
    var p = {
        visitorKey: vkey,
        url: location.href,
        referrer: document.referrer || null,
        ua: ua,
        ts: Date.now()
    };

    // Prefer sendBeacon
    try{
        if (navigator.sendBeacon) {
            var ok = navigator.sendBeacon(API, new Blob([JSON.stringify(p)], {type:"application/json"}));
            if (ok) return;
        }
    }catch(e){}

    // Fallback to fetch (adds x-vkey header, helpful for your rate limiter)
    try{
        if (typeof fetch === "function") {
            fetch(API, {
                method: "POST",
                headers: {"Content-Type":"application/json", "x-vkey": vkey},
                body: JSON.stringify(p),
                keepalive: true
            }).catch(function(){});
        }
    }catch(e){}
})();
